<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GoCollab Editor</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: #f4f4f9; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            height: 100vh; 
            margin: 0; 
            overflow: hidden; 
        }

        #login-screen { 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100%; 
            width: 100%; 
            position: absolute; 
            background: #f4f4f9; 
            z-index: 10; 
            padding: 20px;
            box-sizing: border-box;
        }

        .login-box { 
            background: white; 
            padding: 30px 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
            text-align: center; 
            width: 100%; 
            max-width: 350px; 
        }

        .login-box h2 { margin-top: 0; color: #333; }

        .login-box input { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-size: 16px; 
        }

        .login-box button { 
            width: 100%; 
            padding: 12px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: bold;
            margin-top: 10px;
        }

        #app-screen { 
            display: none; 
            width: 95%; 
            max-width: 800px; 
            height: 100%;
            padding-top: 15px;
            box-sizing: border-box;
        }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px; 
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .header-left { 
            display: flex; 
            flex-direction: column; 
            gap: 2px; 
        }

        h3 { margin: 0; font-size: 16px; color: #333; }
        
        #status { 
            font-size: 12px; 
            color: #666; 
            background: transparent;
            padding: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        #status::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #dc3545; 
            transition: background-color 0.3s ease;
            
        }
        #status.connected::before {
            background-color: #28a745; 
            box-shadow: 0 0 5px #28a745;
        }

        .btn-close { 
            padding: 8px 12px; 
            background: #f8f9fa; 
            color: #333; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px; 
        }

        textarea { 
            width: 100%; 
            height: 70vh;
            border: 1px solid #ccc; 
            border-radius: 8px; 
            padding: 15px; 
            font-size: 16px; 
            font-family: 'Courier New', Courier, monospace; 
            resize: none; 
            box-sizing: border-box;
            outline: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }

        textarea:focus { border-color: #007bff; }

        .footer { 
            margin-top: 10px; 
            display: flex; 
            justify-content: center; 
            padding-bottom: 20px;
        }

        .btn-save { 
            width: 100%;
            padding: 12px; 
            background: #28a745; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: bold;
            display: flex; 
            align-items: center; 
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(40, 167, 69, 0.2);
        }

        @media (max-width: 600px) {
            .header { padding: 8px; }
            h3 { font-size: 14px; }
            textarea { font-size: 14px; height: 65vh; }
            #app-screen { width: 100%; padding: 10px; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>ðŸš€ GoCollab</h2>
            <p style="color: #666; margin-bottom: 20px;">Real-time Editor</p>
            <input type="text" id="usernameInput" placeholder="Enter your name" />
            <input type="text" id="roomInput" placeholder="Enter Room Name" />
            <button onclick="handleLogin()">Join Room</button>
        </div>
    </div>

    <div id="app-screen">
        <div class="header">
            <div class="header-left">
                <h3>ðŸ“‚ <span id="displayRoom">...</span></h3>
                <span id="status">Disconnected</span>
            </div>
            <button class="btn-close" onclick="closeRoom()">Exit</button>
        </div>

        <textarea id="editor" placeholder="Type here..."></textarea>

        <div class="footer">
            <button class="btn-save" onclick="downloadFile()">
                ðŸ“¥ Save to Device
            </button>
        </div>
    </div>

    <script>
        let ROOM_ID = "";
        let MY_ID = ""; 
        let ws;

        const loginScreen = document.getElementById("login-screen");
        const appScreen = document.getElementById("app-screen");
        const editor = document.getElementById("editor");
        const status = document.getElementById("status");
        const displayRoom = document.getElementById("displayRoom");

        window.onload = function() {
            const savedUser = localStorage.getItem("collab_username");
            const savedRoom = localStorage.getItem("collab_room");

            if (savedUser && savedRoom) {
                document.getElementById("usernameInput").value = savedUser;
                document.getElementById("roomInput").value = savedRoom;
                
                loginScreen.style.display = "none";
                appScreen.style.display = "block";

                handleLogin();
            } else {
                loginScreen.style.display = "flex";
                appScreen.style.display = "none";
            }
        };

        async function handleLogin() {
            const username = document.getElementById("usernameInput").value.trim();
            const room = document.getElementById("roomInput").value.trim();

            if (!username || !room) {
                alert("Please enter both Username and Room Name");
                loginScreen.style.display = "flex";
                appScreen.style.display = "none";
                return;
            }

            localStorage.setItem("collab_username", username);
            localStorage.setItem("collab_room", room);

            ROOM_ID = room;
            displayRoom.innerText = ROOM_ID;

            try {
                const response = await fetch(`/login?user=${username}`);
                if (!response.ok) throw new Error("Login failed");
                const token = await response.text();

                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const payload = JSON.parse(window.atob(base64));
                MY_ID = payload.user_id;

                loginScreen.style.display = "none";
                appScreen.style.display = "block";

                await loadDocumentHistory(token);
                connectWebSocket(token);

            } catch (err) {
                console.error(err);
                alert("Login failed. Check server.");
                closeRoom();
            }
        }

        function closeRoom() {
            localStorage.removeItem("collab_username");
            localStorage.removeItem("collab_room");

            if (ws) {
                ws.close();
                ws = null;
            }

            ROOM_ID = "";
            MY_ID = "";
            editor.value = "";
            document.getElementById("usernameInput").value = "";
            document.getElementById("roomInput").value = "";

            appScreen.style.display = "none";
            loginScreen.style.display = "flex";


            status.innerText = "Disconnected";
            status.style.backgroundColor = "#dc3545"; 
        }

        async function loadDocumentHistory(token) {
            try {
                const res = await fetch(`/document?room=${ROOM_ID}&token=${token}`);
                const doc = await res.json();
                
                if (doc.operations && doc.operations.length > 0) {
                    let fullText = "";
                    for (const op of doc.operations) {
                         if (op.type === "INSERT") {
                             const pos = Math.min(op.position, fullText.length);
                             fullText = fullText.slice(0, pos) + op.value + fullText.slice(pos);
                         } else if (op.type === "DELETE") {
                             const pos = Math.min(op.position, fullText.length);
                             fullText = fullText.slice(0, pos) + fullText.slice(pos + 1);
                         }
                    }
                    editor.value = fullText;
                }
            } catch (err) {
                console.error("Could not load history:", err);
            }
        }

        function connectWebSocket(token) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const WS_URL = `${protocol}//${host}/ws?room=${ROOM_ID}&token=${token}`;
            
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                status.innerText = "Connected as " + MY_ID;
                status.style.backgroundColor = "#28a745"; 
            };

            ws.onclose = () => {
                if (appScreen.style.display === "block") {
                    status.innerText = "Disconnected";
                    status.style.backgroundColor = "#dc3545"; 
                }
            };

            ws.onmessage = (event) => {
                const op = JSON.parse(event.data);
                if (op.clientId === MY_ID) return; 

                const text = editor.value;
                const pos = Math.min(op.position, text.length);

                if (op.type === "INSERT") {
                    editor.value = text.slice(0, pos) + op.value + text.slice(pos);
                } 
                else if (op.type === "DELETE") {
                    editor.value = text.slice(0, pos) + text.slice(pos + 1);
                }
            };
        }

        editor.addEventListener("input", (e) => {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            if (e.inputType === "insertText" || e.inputType === "insertLineBreak") {
                const char = e.data || "\n"; 
                const op = {
                    type: "INSERT",
                    position: editor.selectionStart - 1, 
                    value: char
                };
                ws.send(JSON.stringify(op));
            }
            else if (e.inputType === "deleteContentBackward") {
                const op = {
                    type: "DELETE",
                    position: editor.selectionStart, 
                    value: ""
                };
                ws.send(JSON.stringify(op));
            }
        });

        function downloadFile() {
            const text = editor.value;
            const blob = new Blob([text], { type: "text/plain" });
            const anchor = document.createElement("a");
            anchor.href = URL.createObjectURL(blob);
            anchor.download = `${ROOM_ID}.txt`;
            document.body.appendChild(anchor);
            anchor.click();
            document.body.removeChild(anchor);
        }
    </script>
</body>
</html>