<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Go Docs</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
        #status { padding: 5px; color: white; background: red; display: inline-block; border-radius: 4px; font-size: 12px;}
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-height: 500px;}
        textarea { width: 100%; height: 400px; border: 1px solid #ddd; padding: 10px; font-size: 16px; margin-top: 10px; }
        h2 { margin-top: 0; }
    </style>
</head>
<body>

    <div class="container">
        <h2>ðŸ“„ My Go Docs <span id="status">Disconnected</span></h2>
        <p>Open this file in two different tabs (or browsers) to test collaboration.</p>
        <textarea id="editor" placeholder="Start typing..."></textarea>
    </div>

    <script>
    const ROOM_ID = "doc1";
    let MY_ID = ""; 
    let ws;

    const editor = document.getElementById("editor");
    const status = document.getElementById("status");

    function getStoredUser() {
        let user = localStorage.getItem("collab_user_id");
        if (!user) {
            user = "User-" + Math.floor(Math.random() * 1000);
            localStorage.setItem("collab_user_id", user);
        }
        return user;
    }

    async function start() {
        const user = getStoredUser();
        
        const response = await fetch(`/login?user=${user}`);
        const token = await response.text();
        
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const payload = JSON.parse(window.atob(base64));
        MY_ID = payload.user_id;

        await loadDocumentHistory(token);

        connectWebSocket(token);
    }

    async function loadDocumentHistory(token) {
        try {
            const res = await fetch(`/document?room=${ROOM_ID}&token=${token}`);
            const doc = await res.json();
            
            if (doc.Operations && doc.Operations.length > 0) {
                
                let fullText = "";
                for (const op of doc.Operations) {
                     if (op.type === "INSERT") {
                         const pos = op.position;
                         const safePos = Math.min(pos, fullText.length);
                         fullText = fullText.slice(0, safePos) + op.value + fullText.slice(safePos);
                     } else if (op.type === "DELETE") {
                         const pos = op.position;
                         const safePos = Math.min(pos, fullText.length);
                         fullText = fullText.slice(0, safePos) + fullText.slice(safePos + 1);
                     }
                }
                editor.value = fullText;
            }
        } catch (err) {
            console.error("Could not load history:", err);
        }
    }

    function connectWebSocket(token) {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        const WS_URL = `${protocol}//${host}/ws?room=${ROOM_ID}&token=${token}`;
        
        ws = new WebSocket(WS_URL);

        ws.onopen = () => {
            status.innerText = "Connected as " + MY_ID;
            status.style.backgroundColor = "green";
        };

        ws.onmessage = (event) => {
            const op = JSON.parse(event.data);
            if (op.clientId === MY_ID) return; 

            const text = editor.value;
       
            const pos = Math.min(op.position, text.length);

            if (op.type === "INSERT") {
                editor.value = text.slice(0, pos) + op.value + text.slice(pos);
            } 
            else if (op.type === "DELETE") {
                editor.value = text.slice(0, pos) + text.slice(pos + 1);
            }
        };
    }

    editor.addEventListener("input", (e) => {
        if (!ws || ws.readyState !== WebSocket.OPEN) return;

        if (e.inputType === "insertText" || e.inputType === "insertLineBreak") {
            const char = e.data || "\n"; 
            const op = {
                type: "INSERT",
                position: editor.selectionStart - 1, 
                value: char
            };
            ws.send(JSON.stringify(op));
        }
        else if (e.inputType === "deleteContentBackward") {
            const op = {
                type: "DELETE",
                position: editor.selectionStart, 
                value: ""
            };
            ws.send(JSON.stringify(op));
        }
    });

    start();
</script>
</body>
</html>