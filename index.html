<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Go Docs</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
        #status { padding: 5px; color: white; background: red; display: inline-block; border-radius: 4px; font-size: 12px;}
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-height: 500px;}
        textarea { width: 100%; height: 400px; border: 1px solid #ddd; padding: 10px; font-size: 16px; margin-top: 10px; }
        h2 { margin-top: 0; }
    </style>
</head>
<body>

    <div class="container">
        <h2>ðŸ“„ My Go Docs <span id="status">Disconnected</span></h2>
        <p>Open this file in two different tabs (or browsers) to test collaboration.</p>
        <textarea id="editor" placeholder="Start typing..."></textarea>
    </div>

    <script>
        const ROOM_ID = "doc1";
        let MY_ID = ""; 
        let ws;

        const editor = document.getElementById("editor");
        const status = document.getElementById("status");

        async function start() {
            const randomUser = "User-" + Math.floor(Math.random() * 1000);
            const response = await fetch(`/login?user=${randomUser}`);
            const token = await response.text();
            
            console.log("Got Token:", token);

            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const payload = JSON.parse(window.atob(base64));
            MY_ID = payload.user_id;
            console.log("My Authenticated ID:", MY_ID);

            connectWebSocket(token);
        }

        function connectWebSocket(token) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
    
            const WS_URL = `${protocol}//${host}/ws?room=${ROOM_ID}&token=${token}`;
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                status.innerText = "Connected as " + MY_ID;
                status.style.backgroundColor = "green";
            };

            ws.onmessage = (event) => {
                const op = JSON.parse(event.data);
                
                if (op.clientId === MY_ID) return; 

                if (op.type === "INSERT") {
                    editor.value += op.value;
                }
            };
        }

        editor.addEventListener("input", (e) => {
            if (e.inputType === "insertText" || e.inputType === "insertLineBreak") {
                const char = e.data || "\n"; 
                const op = {
                    type: "INSERT",
                    position: editor.value.length, 
                    value: char,
                };
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(op));
                }
            }
        });

        start();
    </script>
</body>
</html>